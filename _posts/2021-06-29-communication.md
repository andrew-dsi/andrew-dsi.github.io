---
layout: post
title: Creating An Image Search Engine Using Deep Learning
image: "/posts/deep-learning-brain.jpg"
tags: [Deep Learning, CNN, Data Science, Computer Vision, Python]
---

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vestibulum nunc justo, dignissim ac condimentum ut, lacinia vitae ante. Ut ipsum tellus, euismod at vehicula vitae, dapibus at augue. Nam nec eros ac nunc molestie fermentum. Integer ut mi varius, elementum ex et, finibus orci. Sed molestie ipsum non eros pulvinar interdum at ac mauris. Aliquam in erat malesuada, porttitor elit eget, lobortis ante. Praesent sit amet nisl metus. Quisque feugiat, justo maximus faucibus sollicitudin, turpis ipsum mattis lectus, sed faucibus ipsum metus ac orci. Mauris non est sit amet ante interdum vehicula quis sed lorem. Etiam gravida facilisis tempus. Nulla posuere neque facilisis ligula maximus maximus. Suspendisse venenatis sapien quis libero vulputate suscipit. Vivamus egestas enim nibh, tristique volutpat erat dapibus eu. Ut ligula leo, cursus vel rhoncus ultricies, efficitur et lectus. Aliquam ornare dignissim risus ut rhoncus.

Nulla sed purus sed mi interdum finibus. Suspendisse maximus purus id dolor varius iaculis. Fusce vulputate quam diam, ac cursus augue euismod vel. Fusce felis lorem, bibendum tempus imperdiet at, malesuada ac libero. Ut dolor nisl, pellentesque id nisl non, feugiat egestas nisi. Nulla gravida turpis a felis ornare venenatis. Sed in luctus mauris. Fusce tempus augue sed ornare tincidunt. Aliquam erat volutpat. Maecenas sagittis dignissim augue, hendrerit sagittis magna eleifend vel. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Mauris porta, mauris sed gravida viverra, diam massa semper quam, et eleifend enim erat vel urna. Aenean nec dolor nec turpis condimentum vehicula. Pellentesque consequat commodo orci at elementum. Integer facilisis dictum libero, ut porta felis feugiat id. Vestibulum urna dolor, vestibulum vitae neque quis, ullamcorper accumsan ligula.

Fusce eu quam justo. Duis feugiat est ut semper consequat. Etiam ultricies tellus nec gravida pulvinar. Nam sed blandit ante. Nunc semper pulvinar bibendum. Nullam vel est id arcu molestie pellentesque. Aliquam in est nec nibh varius malesuada.

Sed condimentum orci vitae luctus laoreet. Aliquam tincidunt egestas libero, vitae interdum nisi aliquam eget. Maecenas feugiat felis ut nunc pulvinar pharetra. Maecenas pretium mauris nec orci scelerisque mollis. Duis commodo augue sed tortor tristique rhoncus. Donec rutrum varius libero vel suscipit. In sed sollicitudin nisi, at ullamcorper nisl. Maecenas laoreet elit sit amet dui congue, et dignissim sem laoreet. Nulla sed justo quis odio auctor aliquam. Nunc nisl mi, bibendum a feugiat id, venenatis at lorem.

Integer fringilla felis id metus hendrerit molestie. Aliquam sed neque nec augue hendrerit fermentum ac quis justo. Suspendisse varius odio vitae quam euismod vehicula. Suspendisse placerat elit mauris, vitae eleifend ipsum suscipit ac. Pellentesque metus magna, accumsan a nisi ut, feugiat tempor risus. Nunc facilisis blandit ex, sit amet accumsan nunc bibendum volutpat. Cras auctor imperdiet fermentum.

Cras cursus pretium rutrum. In hac habitasse platea dictumst. Integer sed nibh non massa imperdiet imperdiet. Fusce rhoncus tempus nunc vitae eleifend. Aliquam erat volutpat. Nulla bibendum, risus eget lobortis aliquet, neque dui tempor elit, eget mattis quam sapien et nisi. Nulla finibus semper libero in auctor. Aenean ornare dolor sit amet leo convallis iaculis. Cras pulvinar nibh id lorem tempor, a luctus leo maximus. Vivamus interdum mauris tellus, ut pretium ipsum ultrices sit amet. Nam dignissim ac lectus in scelerisque. Integer non eros nec ante ultrices porttitor nec a nunc. Vivamus lacinia aliquet varius.

Sed sed consectetur risus. Proin vestibulum pulvinar metus accumsan aliquam. Suspendisse metus lacus, dictum ac augue sit amet, venenatis accumsan ligula. Donec luctus ut libero vel faucibus. Nunc venenatis justo a nibh sagittis aliquet. Mauris vel orci mi. Vivamus molestie tincidunt ipsum, sed elementum nunc blandit ac. Pellentesque malesuada feugiat blandit. Morbi vitae mi vestibulum, lacinia dolor nec, auctor nisl. Sed diam dui, sodales at eros eget, ullamcorper bibendum arcu. Donec mollis interdum nulla, id varius turpis fringilla eget. Maecenas vel leo at nulla tincidunt auctor nec non nisl.

Fusce eu libero dui. Ut rhoncus, libero sit amet lobortis viverra, nunc turpis placerat eros, eget feugiat nisi nibh id nisl. Ut aliquet aliquam purus at volutpat. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Morbi porta congue mauris a cursus. Praesent viverra purus eu turpis iaculis rutrum. Vivamus semper sed elit eu vulputate.

Duis pretium viverra faucibus. Fusce nec magna vel diam ornare efficitur. Maecenas vulputate ipsum vitae suscipit auctor. Duis sed sem nulla. Praesent bibendum felis orci, eu pretium est semper eu. Mauris et placerat tellus, a finibus tortor. Aliquam hendrerit mi vel metus commodo, et ullamcorper lacus elementum. Vestibulum cursus leo nisi. Nam sodales metus ac est facilisis mattis. Curabitur hendrerit consectetur neque, in pretium ligula varius mollis. Suspendisse eu eros eleifend, egestas lorem at, ullamcorper libero. In gravida cursus sapien ut tristique. Sed volutpat, lectus ac efficitur dictum, diam purus blandit urna, eleifend maximus enim justo eu elit. Nullam eu maximus libero. Nulla id erat sed nisl pretium fermentum.

Nam non euismod arcu. Fusce volutpat suscipit purus, eget laoreet purus molestie id. Duis faucibus nunc est, in venenatis nunc scelerisque quis. In hac habitasse platea dictumst. Maecenas venenatis, neque ut faucibus pretium, felis lorem venenatis risus, nec rhoncus odio tortor quis eros. Sed quis mauris eros. Proin interdum metus enim, vitae facilisis odio condimentum et. Phasellus ac elit accumsan, pretium dui id, rhoncus eros. Mauris cursus, ipsum in hendrerit laoreet, augue nisl pharetra lacus, at faucibus quam diam quis libero. Aliquam fringilla nulla ut faucibus fringilla. Aliquam vel varius est. Morbi quis molestie arcu. Pellentesque venenatis metus in porttitor semper. Sed eu nisl hendrerit, volutpat lectus quis, vulputate ex. Pellentesque rhoncus volutpat eros quis ornare.

```

#########################################################################
# Convolutional Neural Network - Image Search Engine
#########################################################################


###########################################################################################
# import packages
###########################################################################################

from tensorflow.keras.models import Model, load_model
from tensorflow.keras.applications.vgg16 import VGG16, preprocess_input
from tensorflow.keras.preprocessing.image import load_img, img_to_array
import numpy as np
from os import listdir
from sklearn.neighbors import NearestNeighbors
import matplotlib.pyplot as plt
import pickle

###########################################################################################
# bring in pre-trained model (excluding top)
###########################################################################################

# image parameters

img_width = 224
img_height = 224
num_channels = 3

# network architecture

vgg = VGG16(input_shape = (img_width, img_height, num_channels), include_top = False, pooling = 'avg')

model = Model(inputs = vgg.input, outputs = vgg.layers[-1].output)

# save model file

model.save('models/vgg16_search_engine.h5')


###########################################################################################
# preprocessing & featurising functions
###########################################################################################

# image pre-processing function

def preprocess_image(filepath):
    
    image = load_img(filepath, target_size = (img_width, img_height))
    image = img_to_array(image)
    image = np.expand_dims(image, axis = 0)
    image = preprocess_input(image)
    
    return image

# featurise image

def featurise_image(image):
    
    feature_vector = model.predict(image)
    
    return feature_vector

###########################################################################################
# featurise base images
###########################################################################################

# source directory for base images

source_dir = 'data/'

# empty objects to append to

filename_store = []
feature_vector_store = np.empty((0,512))

# pass in & featurise base image set

for image in listdir(source_dir):
    
    print(image)
    
    # append image filename for future lookup
    filename_store.append(source_dir + image)
    
    # preprocess the image
    preprocessed_image = preprocess_image(source_dir + image)
    
    # extract the feature vector
    feature_vector = featurise_image(preprocessed_image)
    
    # append feature vector for similarity calculations
    feature_vector_store = np.append(feature_vector_store, feature_vector, axis = 0)

# save key objects for future use

pickle.dump(filename_store, open('models/filename_store.p', 'wb'))
pickle.dump(feature_vector_store, open('models/feature_vector_store.p', 'wb'))

        
###########################################################################################
# pass in new image, and return similar images
###########################################################################################

# load in required objects

model = load_model('models/vgg16_search_engine.h5', compile = False)

filename_store = pickle.load(open('models/filename_store.p', 'rb'))
feature_vector_store = pickle.load(open('models/feature_vector_store.p', 'rb'))

# search parameters

search_results_n = 8
search_image = 'search_image_02.jpg'
        
# preprocess & featurise search image

preprocessed_image = preprocess_image(search_image)
search_feature_vector = featurise_image(preprocessed_image)
        
# instantiate nearest neighbours logic

image_neighbours = NearestNeighbors(n_neighbors = search_results_n, metric = 'cosine')

# apply to our feature vector store

image_neighbours.fit(feature_vector_store)

# return search results for search image (distances & indices)

image_distances, image_indices = image_neighbours.kneighbors(search_feature_vector)

# convert closest image indices & distances to lists

image_indices = list(image_indices[0])
image_distances = list(image_distances[0])

# get list of filenames for search results

search_result_files = [filename_store[i] for i in image_indices]

# plot results

plt.figure(figsize=(12,9))
for counter, result_file in enumerate(search_result_files):    
    image = load_img(result_file)
    ax = plt.subplot(3, 3, counter+1)
    plt.imshow(image)
    plt.text(0, -5, round(image_distances[counter],3))
    ax.get_xaxis().set_visible(False)
    ax.get_yaxis().set_visible(False)
plt.show()


```
